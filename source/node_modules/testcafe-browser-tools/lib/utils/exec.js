"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = __importDefault(require("child_process"));
const fs_1 = __importDefault(require("fs"));
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const del_1 = __importDefault(require("del"));
const execa_1 = __importDefault(require("execa"));
const os_family_1 = __importDefault(require("os-family"));
const nanoid_1 = __importDefault(require("nanoid"));
const promisify_1 = __importDefault(require("./promisify"));
const binaries_1 = __importDefault(require("../binaries"));
const flatten_whitespace_1 = __importDefault(require("./flatten-whitespace"));
const get_environment_variable_1 = __importDefault(require("./get-environment-variable"));
const errors_1 = require("../errors");
const EXIT_CODE_REGEXP = /Exit code: (-?\d+)/;
const OPEN_PATH = '/usr/bin/open';
const TEMP_PIPE_NAME = seed => `testcafe-browser-tools-fifo-${seed}`;
const WINDOWS_DIR = get_environment_variable_1.default('SystemRoot') || 'C:\\Windows';
const SYSTEM32_DIR = path_1.default.join(WINDOWS_DIR, 'System32');
const CHCP_COM = path_1.default.join(SYSTEM32_DIR, 'chcp.com');
const POWERSHELL_DIR = path_1.default.join(SYSTEM32_DIR, 'WindowsPowerShell\\v1.0');
const POWERSHELL_BINARY = path_1.default.join(POWERSHELL_DIR, 'powershell.exe');
const POWERSHELL_ARGS = ['-NoProfile', '-NoLogo', '-NonInteractive', '-Command'];
const POWERSHELL_COMMAND_WRAPPER = command => flatten_whitespace_1.default `
    $cp = (${CHCP_COM} | Select-String '\d+').Matches.Value;
    Try
    {
        ${CHCP_COM} 65001;
        ${command};
    }
    Finally
    {
        ${CHCP_COM} $cp;
    }
`;
function getTempPipePath() {
    return path_1.default.join(os_1.default.tmpdir(), TEMP_PIPE_NAME(nanoid_1.default()));
}
var execFilePromise = promisify_1.default(child_process_1.default.execFile);
var execPromise = promisify_1.default(child_process_1.default.exec);
function readPipe(pipePath) {
    return new Promise((resolve, reject) => {
        let data = '';
        const stream = fs_1.default.createReadStream(pipePath);
        stream.on('data', newData => {
            data += newData ? newData.toString() : '';
        });
        stream.on('end', () => resolve(data));
        stream.on('error', reject);
    });
}
function spawnApp(pipePath, binaryPath, args) {
    return new Promise((resolve, reject) => {
        const child = child_process_1.default.spawn(OPEN_PATH, ['-n', '-a', binaries_1.default.app, '--args', pipePath, binaryPath, ...args]);
        let outputData = '';
        child.on('error', reject);
        child.on('exit', code => {
            if (code)
                reject(new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, exitCode: code, output: outputData }));
            else
                resolve();
        });
        function dataHandler(data) {
            outputData += String(data);
        }
        child.stdout.on('data', dataHandler);
        child.stderr.on('data', dataHandler);
    });
}
async function runWithMacApp(binaryPath, args) {
    const pipePath = getTempPipePath();
    await execPromise(`mkfifo ${pipePath}`);
    try {
        const [data] = await Promise.all([
            readPipe(pipePath),
            spawnApp(pipePath, binaryPath, args)
        ]);
        const exitCodeMatch = data.match(EXIT_CODE_REGEXP);
        if (!exitCodeMatch)
            return data;
        const exitCode = Number(exitCodeMatch[1]);
        if (exitCode)
            throw new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, output: data, exitCode });
        return data;
    }
    finally {
        await del_1.default(pipePath, { force: true });
    }
}
//API
async function execFile(filePath, args) {
    try {
        if (os_family_1.default.mac)
            return await runWithMacApp(filePath, args);
        return await execFilePromise(filePath, args);
    }
    catch (err) {
        if (err instanceof errors_1.NativeBinaryHasFailedError)
            throw err;
        const errorCode = err.status || err.code;
        if (errorCode === void 0 || typeof errorCode === 'string')
            throw err;
        throw new errors_1.NativeBinaryHasFailedError({ binary: filePath, exitCode: errorCode });
    }
}
exports.execFile = execFile;
async function exec(command) {
    return execPromise(command, { env: process.env });
}
exports.exec = exec;
async function execPowershell(command) {
    const wrappedCommand = POWERSHELL_COMMAND_WRAPPER(command);
    // NOTE: We have to ignore stdin due to a problem with PowerShell 2.0
    // See https://stackoverflow.com/a/9157170/11818061 for details.
    return execa_1.default(POWERSHELL_BINARY, [...POWERSHELL_ARGS, wrappedCommand], { stdin: 'ignore' });
}
exports.execPowershell = execPowershell;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9leGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0VBQXNDO0FBQ3RDLDRDQUFvQjtBQUNwQiw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLDhDQUFzQjtBQUN0QixrREFBMEI7QUFDMUIsMERBQTJCO0FBQzNCLG9EQUE0QjtBQUM1Qiw0REFBb0M7QUFDcEMsMkRBQW1DO0FBQ25DLDhFQUFxRDtBQUNyRCwwRkFBZ0U7QUFDaEUsc0NBQXVEO0FBR3ZELE1BQU0sZ0JBQWdCLEdBQUcsb0JBQW9CLENBQUM7QUFFOUMsTUFBTSxTQUFTLEdBQVEsZUFBZSxDQUFDO0FBQ3ZDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsK0JBQStCLElBQUksRUFBRSxDQUFDO0FBRXJFLE1BQU0sV0FBVyxHQUFTLGtDQUFzQixDQUFDLFlBQVksQ0FBQyxJQUFJLGFBQWEsQ0FBQztBQUNoRixNQUFNLFlBQVksR0FBUSxjQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM3RCxNQUFNLFFBQVEsR0FBWSxjQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM5RCxNQUFNLGNBQWMsR0FBTSxjQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0FBQzdFLE1BQU0saUJBQWlCLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUN0RSxNQUFNLGVBQWUsR0FBSyxDQUFDLFlBQVksRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFbkYsTUFBTSwwQkFBMEIsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDLDRCQUFpQixDQUFDO2FBQ25ELFFBQVE7OztVQUdYLFFBQVE7VUFDUixPQUFPOzs7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LEtBQUssVUFBVSxJQUFJLENBQUUsT0FBTztJQUMvQixPQUFPLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUZELG9CQUVDO0FBRU0sS0FBSyxVQUFVLGNBQWMsQ0FBRSxPQUFPO0lBQ3pDLE1BQU0sY0FBYyxHQUFHLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTNELHFFQUFxRTtJQUNyRSxnRUFBZ0U7SUFDaEUsT0FBTyxlQUFLLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxHQUFHLGVBQWUsRUFBRSxjQUFjLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQy9GLENBQUM7QUFORCx3Q0FNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGlsZFByb2MgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGRlbCBmcm9tICdkZWwnO1xuaW1wb3J0IGV4ZWNhIGZyb20gJ2V4ZWNhJztcbmltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IG5hbm9pZCBmcm9tICduYW5vaWQnO1xuaW1wb3J0IHByb21pc2lmeSBmcm9tICcuL3Byb21pc2lmeSc7XG5pbXBvcnQgQklOQVJJRVMgZnJvbSAnLi4vYmluYXJpZXMnO1xuaW1wb3J0IGZsYXR0ZW5XaGl0ZXNwYWNlIGZyb20gJy4vZmxhdHRlbi13aGl0ZXNwYWNlJztcbmltcG9ydCBnZXRFbnZpcm9ubWVudFZhcmlhYmxlIGZyb20gJy4vZ2V0LWVudmlyb25tZW50LXZhcmlhYmxlJztcbmltcG9ydCB7IE5hdGl2ZUJpbmFyeUhhc0ZhaWxlZEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzJztcblxuXG5jb25zdCBFWElUX0NPREVfUkVHRVhQID0gL0V4aXQgY29kZTogKC0/XFxkKykvO1xuXG5jb25zdCBPUEVOX1BBVEggICAgICA9ICcvdXNyL2Jpbi9vcGVuJztcbmNvbnN0IFRFTVBfUElQRV9OQU1FID0gc2VlZCA9PiBgdGVzdGNhZmUtYnJvd3Nlci10b29scy1maWZvLSR7c2VlZH1gO1xuXG5jb25zdCBXSU5ET1dTX0RJUiAgICAgICA9IGdldEVudmlyb25tZW50VmFyaWFibGUoJ1N5c3RlbVJvb3QnKSB8fCAnQzpcXFxcV2luZG93cyc7XG5jb25zdCBTWVNURU0zMl9ESVIgICAgICA9IHBhdGguam9pbihXSU5ET1dTX0RJUiwgJ1N5c3RlbTMyJyk7XG5jb25zdCBDSENQX0NPTSAgICAgICAgICA9IHBhdGguam9pbihTWVNURU0zMl9ESVIsICdjaGNwLmNvbScpO1xuY29uc3QgUE9XRVJTSEVMTF9ESVIgICAgPSBwYXRoLmpvaW4oU1lTVEVNMzJfRElSLCAnV2luZG93c1Bvd2VyU2hlbGxcXFxcdjEuMCcpO1xuY29uc3QgUE9XRVJTSEVMTF9CSU5BUlkgPSBwYXRoLmpvaW4oUE9XRVJTSEVMTF9ESVIsICdwb3dlcnNoZWxsLmV4ZScpO1xuY29uc3QgUE9XRVJTSEVMTF9BUkdTICAgPSBbJy1Ob1Byb2ZpbGUnLCAnLU5vTG9nbycsICctTm9uSW50ZXJhY3RpdmUnLCAnLUNvbW1hbmQnXTtcblxuY29uc3QgUE9XRVJTSEVMTF9DT01NQU5EX1dSQVBQRVIgPSBjb21tYW5kID0+IGZsYXR0ZW5XaGl0ZXNwYWNlIGBcbiAgICAkY3AgPSAoJHtDSENQX0NPTX0gfCBTZWxlY3QtU3RyaW5nICdcXGQrJykuTWF0Y2hlcy5WYWx1ZTtcbiAgICBUcnlcbiAgICB7XG4gICAgICAgICR7Q0hDUF9DT019IDY1MDAxO1xuICAgICAgICAke2NvbW1hbmR9O1xuICAgIH1cbiAgICBGaW5hbGx5XG4gICAge1xuICAgICAgICAke0NIQ1BfQ09NfSAkY3A7XG4gICAgfVxuYDtcblxuZnVuY3Rpb24gZ2V0VGVtcFBpcGVQYXRoICgpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKG9zLnRtcGRpcigpLCBURU1QX1BJUEVfTkFNRShuYW5vaWQoKSkpO1xufVxuXG52YXIgZXhlY0ZpbGVQcm9taXNlID0gcHJvbWlzaWZ5KGNoaWxkUHJvYy5leGVjRmlsZSk7XG52YXIgZXhlY1Byb21pc2UgICAgID0gcHJvbWlzaWZ5KGNoaWxkUHJvYy5leGVjKTtcblxuXG5mdW5jdGlvbiByZWFkUGlwZSAocGlwZVBhdGgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBsZXQgZGF0YSAgICAgPSAnJztcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShwaXBlUGF0aCk7XG5cbiAgICAgICAgc3RyZWFtLm9uKCdkYXRhJywgbmV3RGF0YSA9PiB7XG4gICAgICAgICAgICBkYXRhICs9IG5ld0RhdGEgPyBuZXdEYXRhLnRvU3RyaW5nKCkgOiAnJztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKGRhdGEpKTtcbiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHNwYXduQXBwIChwaXBlUGF0aCwgYmluYXJ5UGF0aCwgYXJncykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRQcm9jLnNwYXduKE9QRU5fUEFUSCwgWyctbicsICctYScsIEJJTkFSSUVTLmFwcCwgJy0tYXJncycsIHBpcGVQYXRoLCBiaW5hcnlQYXRoLCAuLi5hcmdzXSk7XG5cbiAgICAgICAgbGV0IG91dHB1dERhdGEgPSAnJztcblxuICAgICAgICBjaGlsZC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgICAgIGNoaWxkLm9uKCdleGl0JywgY29kZSA9PiB7XG4gICAgICAgICAgICBpZiAoY29kZSlcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IE5hdGl2ZUJpbmFyeUhhc0ZhaWxlZEVycm9yKHsgYmluYXJ5OiBiaW5hcnlQYXRoLCBleGl0Q29kZTogY29kZSwgb3V0cHV0OiBvdXRwdXREYXRhIH0pKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZ1bmN0aW9uIGRhdGFIYW5kbGVyIChkYXRhKSB7XG4gICAgICAgICAgICBvdXRwdXREYXRhICs9IFN0cmluZyhkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNoaWxkLnN0ZG91dC5vbignZGF0YScsIGRhdGFIYW5kbGVyKTtcbiAgICAgICAgY2hpbGQuc3RkZXJyLm9uKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuICAgIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5XaXRoTWFjQXBwIChiaW5hcnlQYXRoLCBhcmdzKSB7XG4gICAgY29uc3QgcGlwZVBhdGggPSBnZXRUZW1wUGlwZVBhdGgoKTtcblxuICAgIGF3YWl0IGV4ZWNQcm9taXNlKGBta2ZpZm8gJHtwaXBlUGF0aH1gKTtcblxuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IFtkYXRhXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHJlYWRQaXBlKHBpcGVQYXRoKSxcbiAgICAgICAgICAgIHNwYXduQXBwKHBpcGVQYXRoLCBiaW5hcnlQYXRoLCBhcmdzKVxuICAgICAgICBdKTtcblxuICAgICAgICBjb25zdCBleGl0Q29kZU1hdGNoID0gZGF0YS5tYXRjaChFWElUX0NPREVfUkVHRVhQKTtcblxuICAgICAgICBpZiAoIWV4aXRDb2RlTWF0Y2gpXG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcblxuICAgICAgICBjb25zdCBleGl0Q29kZSA9IE51bWJlcihleGl0Q29kZU1hdGNoWzFdKTtcblxuICAgICAgICBpZiAoZXhpdENvZGUpXG4gICAgICAgICAgICB0aHJvdyBuZXcgTmF0aXZlQmluYXJ5SGFzRmFpbGVkRXJyb3IoeyBiaW5hcnk6IGJpbmFyeVBhdGgsIG91dHB1dDogZGF0YSwgZXhpdENvZGUgfSk7XG5cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIGZpbmFsbHkge1xuICAgICAgICBhd2FpdCBkZWwocGlwZVBhdGgsIHsgZm9yY2U6IHRydWUgfSk7XG4gICAgfVxufVxuXG4vL0FQSVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGV4ZWNGaWxlIChmaWxlUGF0aCwgYXJncykge1xuICAgIHRyeSB7XG4gICAgICAgIGlmIChPUy5tYWMpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgcnVuV2l0aE1hY0FwcChmaWxlUGF0aCwgYXJncyk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGV4ZWNGaWxlUHJvbWlzZShmaWxlUGF0aCwgYXJncyk7XG4gICAgfVxuICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIE5hdGl2ZUJpbmFyeUhhc0ZhaWxlZEVycm9yKVxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuXG4gICAgICAgIGNvbnN0IGVycm9yQ29kZSA9IGVyci5zdGF0dXMgfHwgZXJyLmNvZGU7XG5cbiAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiBlcnJvckNvZGUgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuXG4gICAgICAgIHRocm93IG5ldyBOYXRpdmVCaW5hcnlIYXNGYWlsZWRFcnJvcih7IGJpbmFyeTogZmlsZVBhdGgsIGV4aXRDb2RlOiBlcnJvckNvZGUgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXhlYyAoY29tbWFuZCkge1xuICAgIHJldHVybiBleGVjUHJvbWlzZShjb21tYW5kLCB7IGVudjogcHJvY2Vzcy5lbnYgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjUG93ZXJzaGVsbCAoY29tbWFuZCkge1xuICAgIGNvbnN0IHdyYXBwZWRDb21tYW5kID0gUE9XRVJTSEVMTF9DT01NQU5EX1dSQVBQRVIoY29tbWFuZCk7XG5cbiAgICAvLyBOT1RFOiBXZSBoYXZlIHRvIGlnbm9yZSBzdGRpbiBkdWUgdG8gYSBwcm9ibGVtIHdpdGggUG93ZXJTaGVsbCAyLjBcbiAgICAvLyBTZWUgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzkxNTcxNzAvMTE4MTgwNjEgZm9yIGRldGFpbHMuXG4gICAgcmV0dXJuIGV4ZWNhKFBPV0VSU0hFTExfQklOQVJZLCBbLi4uUE9XRVJTSEVMTF9BUkdTLCB3cmFwcGVkQ29tbWFuZF0sIHsgc3RkaW46ICdpZ25vcmUnIH0pO1xufVxuIl19