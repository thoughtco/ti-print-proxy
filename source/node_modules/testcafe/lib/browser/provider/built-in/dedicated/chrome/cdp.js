"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.resizeWindow = exports.updateMobileViewportSize = exports.closeTab = exports.isHeadlessTab = exports.createClient = exports.getScreenshotData = void 0;
const path_1 = __importDefault(require("path"));
const os_1 = __importDefault(require("os"));
const chrome_remote_interface_1 = __importDefault(require("chrome-remote-interface"));
const client_functions_1 = require("../../../utils/client-functions");
const DOWNLOADS_DIR = path_1.default.join(os_1.default.homedir(), 'Downloads');
async function getActiveTab(cdpPort, browserId) {
    const tabs = await chrome_remote_interface_1.default.listTabs({ port: cdpPort });
    return tabs.filter(t => t.type === 'page' && t.url.includes(browserId))[0];
}
async function setEmulationBounds({ client, config, viewportSize, emulatedDevicePixelRatio }) {
    await setDeviceMetricsOverride(client, viewportSize.width, viewportSize.height, emulatedDevicePixelRatio, config.mobile);
    await client.Emulation.setVisibleSize({ width: viewportSize.width, height: viewportSize.height });
}
async function setEmulation(runtimeInfo) {
    const { client, config } = runtimeInfo;
    if (config.userAgent !== void 0)
        await client.Network.setUserAgentOverride({ userAgent: config.userAgent });
    if (config.touch !== void 0) {
        const touchConfig = {
            enabled: config.touch,
            configuration: config.mobile ? 'mobile' : 'desktop',
            maxTouchPoints: 1
        };
        if (client.Emulation.setEmitTouchEventsForMouse)
            await client.Emulation.setEmitTouchEventsForMouse(touchConfig);
        if (client.Emulation.setTouchEmulationEnabled)
            await client.Emulation.setTouchEmulationEnabled(touchConfig);
    }
    await resizeWindow({ width: config.width, height: config.height }, runtimeInfo);
}
async function enableDownloads({ client }) {
    await client.Page.setDownloadBehavior({
        behavior: 'allow',
        downloadPath: DOWNLOADS_DIR
    });
}
async function getScreenshotData({ client, config, emulatedDevicePixelRatio }, fullPage) {
    let viewportWidth = 0;
    let viewportHeight = 0;
    if (fullPage) {
        const { contentSize, visualViewport } = await client.Page.getLayoutMetrics();
        await setDeviceMetricsOverride(client, Math.ceil(contentSize.width), Math.ceil(contentSize.height), emulatedDevicePixelRatio, config.mobile);
        viewportWidth = visualViewport.clientWidth;
        viewportHeight = visualViewport.clientHeight;
    }
    const screenshotData = await client.Page.captureScreenshot({});
    if (fullPage) {
        if (config.emulation) {
            await setDeviceMetricsOverride(client, config.width || viewportWidth, config.height || viewportHeight, emulatedDevicePixelRatio, config.mobile);
        }
        else
            await client.Emulation.clearDeviceMetricsOverride();
    }
    return Buffer.from(screenshotData.data, 'base64');
}
exports.getScreenshotData = getScreenshotData;
async function setDeviceMetricsOverride(client, width, height, deviceScaleFactor, mobile) {
    await client.Emulation.setDeviceMetricsOverride({
        width,
        height,
        deviceScaleFactor,
        mobile,
        // @ts-ignore
        fitWindow: false
    });
}
async function createClient(runtimeInfo) {
    const { browserId, config, cdpPort } = runtimeInfo;
    let tab = null;
    let client = null;
    try {
        tab = await getActiveTab(cdpPort, browserId);
        if (!tab)
            return;
        client = await chrome_remote_interface_1.default({ target: tab, port: cdpPort });
    }
    catch (e) {
        return;
    }
    runtimeInfo.tab = tab;
    runtimeInfo.client = client;
    await client.Page.enable();
    await client.Network.enable({});
    await client.Runtime.enable();
    const devicePixelRatioQueryResult = await client.Runtime.evaluate({ expression: 'window.devicePixelRatio' });
    runtimeInfo.originalDevicePixelRatio = devicePixelRatioQueryResult.result.value;
    runtimeInfo.emulatedDevicePixelRatio = config.scaleFactor || runtimeInfo.originalDevicePixelRatio;
    if (config.emulation)
        await setEmulation(runtimeInfo);
    if (config.headless)
        await enableDownloads(runtimeInfo);
}
exports.createClient = createClient;
function isHeadlessTab({ tab, config }) {
    return tab && config.headless;
}
exports.isHeadlessTab = isHeadlessTab;
async function closeTab({ tab, cdpPort }) {
    await chrome_remote_interface_1.default.closeTab({ id: tab.id, port: cdpPort });
}
exports.closeTab = closeTab;
async function updateMobileViewportSize(runtimeInfo) {
    const windowDimensionsQueryResult = await runtimeInfo.client.Runtime.evaluate({
        expression: `(${client_functions_1.GET_WINDOW_DIMENSIONS_INFO_SCRIPT})()`,
        returnByValue: true
    });
    const windowDimensions = windowDimensionsQueryResult.result.value;
    runtimeInfo.viewportSize.width = windowDimensions.outerWidth;
    runtimeInfo.viewportSize.height = windowDimensions.outerHeight;
}
exports.updateMobileViewportSize = updateMobileViewportSize;
async function resizeWindow(newDimensions, runtimeInfo) {
    const { browserId, config, viewportSize, providerMethods } = runtimeInfo;
    const currentWidth = viewportSize.width;
    const currentHeight = viewportSize.height;
    const newWidth = newDimensions.width || currentWidth;
    const newHeight = newDimensions.height || currentHeight;
    if (!config.headless)
        await providerMethods.resizeLocalBrowserWindow(browserId, newWidth, newHeight, currentWidth, currentHeight);
    viewportSize.width = newWidth;
    viewportSize.height = newHeight;
    if (config.emulation)
        await setEmulationBounds(runtimeInfo);
}
exports.resizeWindow = resizeWindow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDRDQUFvQjtBQUNwQixzRkFBbUQ7QUFDbkQsc0VBQW9GO0FBd0NwRixNQUFNLGFBQWEsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLFlBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUUzRCxLQUFLLFVBQVUsWUFBWSxDQUFFLE9BQWUsRUFBRSxTQUFpQjtJQUMzRCxNQUFNLElBQUksR0FBRyxNQUFNLGlDQUFZLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFFNUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvRSxDQUFDO0FBRUQsS0FBSyxVQUFVLGtCQUFrQixDQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsd0JBQXdCLEVBQWU7SUFDdEcsTUFBTSx3QkFBd0IsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsTUFBTSxFQUFFLHdCQUF3QixFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUV6SCxNQUFNLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQ3RHLENBQUM7QUFFRCxLQUFLLFVBQVUs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QUUsYUFBbUIsRUFBRSxXQUF3QjtJQUM3RSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLEdBQUcsV0FBVyxDQUFDO0lBRXpFLE1BQU0sWUFBWSxHQUFJLFlBQVksQ0FBQyxLQUFLLENBQUM7SUFDekMsTUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztJQUMxQyxNQUFNLFFBQVEsR0FBUSxhQUFhLENBQUMsS0FBSyxJQUFJLFlBQVksQ0FBQztJQUMxRCxNQUFNLFNBQVMsR0FBTyxhQUFhLENBQUMsTUFBTSxJQUFJLGFBQWEsQ0FBQztJQUU1RCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7UUFDaEIsTUFBTSxlQUFlLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRWhILFlBQVksQ0FBQyxLQUFLLEdBQUksUUFBUSxDQUFDO0lBQy9CLFlBQVksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO0lBRWhDLElBQUksTUFBTSxDQUFDLFNBQVM7UUFDaEIsTUFBTSxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBaEJELG9DQWdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCByZW1vdGVDaHJvbWUgZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvY2xpZW50LWZ1bmN0aW9ucyc7XG5cbmludGVyZmFjZSBTaXplIHtcbiAgICB3aWR0aDogbnVtYmVyO1xuICAgIGhlaWdodDogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgQ29uZmlnIHtcbiAgICBoZWFkbGVzczogYm9vbGVhbjtcbiAgICBtb2JpbGU6IGJvb2xlYW47XG4gICAgZW11bGF0aW9uOiBmYWxzZTtcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmc7XG4gICAgdG91Y2g/OiBib29sZWFuO1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgaGVpZ2h0OiBudW1iZXI7XG4gICAgc2NhbGVGYWN0b3I6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFByb3ZpZGVyTWV0aG9kcyB7XG4gICAgcmVzaXplTG9jYWxCcm93c2VyV2luZG93IChicm93c2VySWQ6IHN0cmluZywgbmV3V2lkdGg6IG51bWJlciwgbmV3SGVpZ2h0OiBudW1iZXIsIGN1cnJlbnRXaWR0aDogbnVtYmVyLCBjdXJyZW50SGVpZ2h0OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5pbnRlcmZhY2UgUnVudGltZUluZm8ge1xuICAgIGJyb3dzZXJJZDogc3RyaW5nO1xuICAgIGNkcFBvcnQ6IG51bWJlcjtcbiAgICBjbGllbnQ6IHJlbW90ZUNocm9tZS5Qcm90b2NvbEFwaTtcbiAgICB0YWI6IHJlbW90ZUNocm9tZS5UYXJnZXRJbmZvO1xuICAgIGNvbmZpZzogQ29uZmlnO1xuICAgIHZpZXdwb3J0U2l6ZTogU2l6ZTtcbiAgICBlbXVsYXRlZERldmljZVBpeGVsUmF0aW86IG51bWJlcjtcbiAgICBvcmlnaW5hbERldmljZVBpeGVsUmF0aW86IG51bWJlcjtcbiAgICBwcm92aWRlck1ldGhvZHM6IFByb3ZpZGVyTWV0aG9kcztcbn1cblxuaW50ZXJmYWNlIFRvdWNoQ29uZmlnT3B0aW9ucyB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBjb25maWd1cmF0aW9uOiAnZGVza3RvcCcgfCAnbW9iaWxlJztcbiAgICBtYXhUb3VjaFBvaW50czogbnVtYmVyO1xufVxuXG5jb25zdCBET1dOTE9BRFNfRElSID0gcGF0aC5qb2luKG9zLmhvbWVkaXIoKSwgJ0Rvd25sb2FkcycpO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRBY3RpdmVUYWIgKGNkcFBvcnQ6IG51bWJlciwgYnJvd3NlcklkOiBzdHJpbmcpOiBQcm9taXNlPHJlbW90ZUNocm9tZS5UYXJnZXRJbmZvPiB7XG4gICAgY29uc3QgdGFicyA9IGF3YWl0IHJlbW90ZUNocm9tZS5saXN0VGFicyh7IHBvcnQ6IGNkcFBvcnQgfSk7XG5cbiAgICByZXR1cm4gdGFicy5maWx0ZXIodCA9PiB0LnR5cGUgPT09ICdwYWdlJyAmJiB0LnVybC5pbmNsdWRlcyhicm93c2VySWQpKVswXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uQm91bmRzICh7IGNsaWVudCwgY29uZmlnLCB2aWV3cG9ydFNpemUsIGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyB9OiBSdW50aW1lSW5mbyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHNldERldmljZU1ldHJpY3NPdmVycmlkZShjbGllbnQsIHZpZXdwb3J0U2l6ZS53aWR0aCwgdmlld3BvcnRTaXplLmhlaWdodCwgZW11bGF0ZWREZXZpY2VQaXhlbFJhdGlvLCBjb25maWcubW9iaWxlKTtcblxuICAgIGF3YWl0IGNsaWVudC5FbXVsYXRpb24uc2V0VmlzaWJsZVNpemUoeyB3aWR0aDogdmlld3BvcnRTaXplLndpZHRoLCBoZWlnaHQ6IHZpZXdwb3J0U2l6ZS5oZWlnaHQgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldEVtdWxhdGlvbiAocnVudGltZUluZm86IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgeyBjbGllbnQsIGNvbmZpZyB9ID0gcnVudGltZUluZm87XG5cbiAgICBpZiAoY29uZmlnLnVzZXJBZ2VudCAhPT0gdm9pZCAwKVxuICAgICAgICBhd2FpdCBjbGllbnQuTmV0d29yay5zZXRVc2VyQWdlbnRPdmVycmlkZSh7IHVzZXJBZ2VudDogY29uZmlnLnVzZXJBZ2VudCB9KTtcblxuICAgIGlmIChjb25maWcudG91Y2ggIT09IHZvaWQgMCkge1xuICAgICAgICBjb25zdCB0b3VjaENvbmZpZzogVG91Y2hDb25maWdPcHRpb25zID0ge1xuICAgICAgICAgICAgZW5hYmxlZDogICAgICAgIGNvbmZpZy50b3VjaCxcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb246ICBjb25maWcubW9iaWxlID8gJ21vYmlsZScgOiAnZGVza3RvcCcsXG4gICAgICAgICAgICBtYXhUb3VjaFBvaW50czogMVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjbGllbnQuRW11bGF0aW9uLnNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRFbWl0VG91Y2hFdmVudHNGb3JNb3VzZSh0b3VjaENvbmZpZyk7XG5cbiAgICAgICAgaWYgKGNsaWVudC5FbXVsYXRpb24uc2V0VG91Y2hFbXVsYXRpb25FbmFibGVkKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQodG91Y2hDb25maWcpO1xuICAgIH1cblxuICAgIGF3YWl0IHJlc2l6ZVdpbmRvdyh7IHdpZHRoOiBjb25maWcud2lkdGgsIGhlaWdodDogY29uZmlnLmhlaWdodCB9LCBydW50aW1lSW5mbyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVuYWJsZURvd25sb2FkcyAoeyBjbGllbnQgfTogUnVudGltZUluZm8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBjbGllbnQuUGFnZS5zZXREb3dubG9hZEJlaGF2aW9yKHtcbiAgICAgICAgYmVoYXZpb3I6ICAgICAnYWxsb3cnLFxuICAgICAgICBkb3dubG9hZFBhdGg6IERPV05MT0FEU19ESVJcbiAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3REYXRhICh7IGNsaWVudCwgY29uZmlnLCBlbXVsYXRlZERldmljZVBpeGVsUmF0aW8gfTogUnVudGltZUluZm8sIGZ1bGxQYWdlPzogYm9vbGVhbik6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgbGV0IHZpZXdwb3J0V2lkdGggPSAwO1xuICAgIGxldCB2aWV3cG9ydEhlaWdodCA9IDA7XG5cbiAgICBpZiAoZnVsbFBhZ2UpIHtcbiAgICAgICAgY29uc3QgeyBjb250ZW50U2l6ZSwgdmlzdWFsVmlld3BvcnQgfSA9IGF3YWl0IGNsaWVudC5QYWdlLmdldExheW91dE1ldHJpY3MoKTtcblxuICAgICAgICBhd2FpdCBzZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUoXG4gICAgICAgICAgICBjbGllbnQsXG4gICAgICAgICAgICBNYXRoLmNlaWwoY29udGVudFNpemUud2lkdGgpLFxuICAgICAgICAgICAgTWF0aC5jZWlsKGNvbnRlbnRTaXplLmhlaWdodCksXG4gICAgICAgICAgICBlbXVsYXRlZERldmljZVBpeGVsUmF0aW8sXG4gICAgICAgICAgICBjb25maWcubW9iaWxlKTtcblxuICAgICAgICB2aWV3cG9ydFdpZHRoID0gdmlzdWFsVmlld3BvcnQuY2xpZW50V2lkdGg7XG4gICAgICAgIHZpZXdwb3J0SGVpZ2h0ID0gdmlzdWFsVmlld3BvcnQuY2xpZW50SGVpZ2h0O1xuICAgIH1cblxuICAgIGNvbnN0IHNjcmVlbnNob3REYXRhID0gYXdhaXQgY2xpZW50LlBhZ2UuY2FwdHVyZVNjcmVlbnNob3Qoe30pO1xuXG4gICAgaWYgKGZ1bGxQYWdlKSB7XG4gICAgICAgIGlmIChjb25maWcuZW11bGF0aW9uKSB7XG4gICAgICAgICAgICBhd2FpdCBzZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUoXG4gICAgICAgICAgICAgICAgY2xpZW50LFxuICAgICAgICAgICAgICAgIGNvbmZpZy53aWR0aCB8fCB2aWV3cG9ydFdpZHRoLFxuICAgICAgICAgICAgICAgIGNvbmZpZy5oZWlnaHQgfHwgdmlld3BvcnRIZWlnaHQsXG4gICAgICAgICAgICAgICAgZW11bGF0ZWREZXZpY2VQaXhlbFJhdGlvLFxuICAgICAgICAgICAgICAgIGNvbmZpZy5tb2JpbGUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IGNsaWVudC5FbXVsYXRpb24uY2xlYXJEZXZpY2VNZXRyaWNzT3ZlcnJpZGUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc2NyZWVuc2hvdERhdGEuZGF0YSwgJ2Jhc2U2NCcpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUgKGNsaWVudDogcmVtb3RlQ2hyb21lLlByb3RvY29sQXBpLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZGV2aWNlU2NhbGVGYWN0b3I6IG51bWJlciwgbW9iaWxlOiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUoe1xuICAgICAgICB3aWR0aCxcbiAgICAgICAgaGVpZ2h0LFxuICAgICAgICBkZXZpY2VTY2FsZUZhY3RvcixcbiAgICAgICAgbW9iaWxlLFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGZpdFdpbmRvdzogZmFsc2VcbiAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUNsaWVudCAocnVudGltZUluZm86IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgeyBicm93c2VySWQsIGNvbmZpZywgY2RwUG9ydCB9ID0gcnVudGltZUluZm87XG5cbiAgICBsZXQgdGFiICAgID0gbnVsbDtcbiAgICBsZXQgY2xpZW50ID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICAgIHRhYiA9IGF3YWl0IGdldEFjdGl2ZVRhYihjZHBQb3J0LCBicm93c2VySWQpO1xuXG4gICAgICAgIGlmICghdGFiKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNsaWVudCA9IGF3YWl0IHJlbW90ZUNocm9tZSh7IHRhcmdldDogdGFiLCBwb3J0OiBjZHBQb3J0IH0pO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcnVudGltZUluZm8udGFiICAgID0gdGFiO1xuICAgIHJ1bnRpbWVJbmZvLmNsaWVudCA9IGNsaWVudDtcblxuICAgIGF3YWl0IGNsaWVudC5QYWdlLmVuYWJsZSgpO1xuICAgIGF3YWl0IGNsaWVudC5OZXR3b3JrLmVuYWJsZSh7fSk7XG4gICAgYXdhaXQgY2xpZW50LlJ1bnRpbWUuZW5hYmxlKCk7XG5cbiAgICBjb25zdCBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQgPSBhd2FpdCBjbGllbnQuUnVudGltZS5ldmFsdWF0ZSh7IGV4cHJlc3Npb246ICd3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbycgfSk7XG5cbiAgICBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW8gPSBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgIHJ1bnRpbWVJbmZvLmVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyA9IGNvbmZpZy5zY2FsZUZhY3RvciB8fCBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW87XG5cbiAgICBpZiAoY29uZmlnLmVtdWxhdGlvbilcbiAgICAgICAgYXdhaXQgc2V0RW11bGF0aW9uKHJ1bnRpbWVJbmZvKTtcblxuICAgIGlmIChjb25maWcuaGVhZGxlc3MpXG4gICAgICAgIGF3YWl0IGVuYWJsZURvd25sb2FkcyhydW50aW1lSW5mbyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0hlYWRsZXNzVGFiICh7IHRhYiwgY29uZmlnIH06IFJ1bnRpbWVJbmZvKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRhYiAmJiBjb25maWcuaGVhZGxlc3M7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbG9zZVRhYiAoeyB0YWIsIGNkcFBvcnQgfTogUnVudGltZUluZm8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCByZW1vdGVDaHJvbWUuY2xvc2VUYWIoeyBpZDogdGFiLmlkLCBwb3J0OiBjZHBQb3J0IH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIChydW50aW1lSW5mbzogUnVudGltZUluZm8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB3aW5kb3dEaW1lbnNpb25zUXVlcnlSZXN1bHQgPSBhd2FpdCBydW50aW1lSW5mby5jbGllbnQuUnVudGltZS5ldmFsdWF0ZSh7XG4gICAgICAgIGV4cHJlc3Npb246ICAgIGAoJHtHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFR9KSgpYCxcbiAgICAgICAgcmV0dXJuQnlWYWx1ZTogdHJ1ZVxuICAgIH0pO1xuXG4gICAgY29uc3Qgd2luZG93RGltZW5zaW9ucyA9IHdpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdC5yZXN1bHQudmFsdWU7XG5cbiAgICBydW50aW1lSW5mby52aWV3cG9ydFNpemUud2lkdGggID0gd2luZG93RGltZW5zaW9ucy5vdXRlcldpZHRoO1xuICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS5oZWlnaHQgPSB3aW5kb3dEaW1lbnNpb25zLm91dGVySGVpZ2h0O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzaXplV2luZG93IChuZXdEaW1lbnNpb25zOiBTaXplLCBydW50aW1lSW5mbzogUnVudGltZUluZm8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IGJyb3dzZXJJZCwgY29uZmlnLCB2aWV3cG9ydFNpemUsIHByb3ZpZGVyTWV0aG9kcyB9ID0gcnVudGltZUluZm87XG5cbiAgICBjb25zdCBjdXJyZW50V2lkdGggID0gdmlld3BvcnRTaXplLndpZHRoO1xuICAgIGNvbnN0IGN1cnJlbnRIZWlnaHQgPSB2aWV3cG9ydFNpemUuaGVpZ2h0O1xuICAgIGNvbnN0IG5ld1dpZHRoICAgICAgPSBuZXdEaW1lbnNpb25zLndpZHRoIHx8IGN1cnJlbnRXaWR0aDtcbiAgICBjb25zdCBuZXdIZWlnaHQgICAgID0gbmV3RGltZW5zaW9ucy5oZWlnaHQgfHwgY3VycmVudEhlaWdodDtcblxuICAgIGlmICghY29uZmlnLmhlYWRsZXNzKVxuICAgICAgICBhd2FpdCBwcm92aWRlck1ldGhvZHMucmVzaXplTG9jYWxCcm93c2VyV2luZG93KGJyb3dzZXJJZCwgbmV3V2lkdGgsIG5ld0hlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KTtcblxuICAgIHZpZXdwb3J0U2l6ZS53aWR0aCAgPSBuZXdXaWR0aDtcbiAgICB2aWV3cG9ydFNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0O1xuXG4gICAgaWYgKGNvbmZpZy5lbXVsYXRpb24pXG4gICAgICAgIGF3YWl0IHNldEVtdWxhdGlvbkJvdW5kcyhydW50aW1lSW5mbyk7XG59XG4iXX0=