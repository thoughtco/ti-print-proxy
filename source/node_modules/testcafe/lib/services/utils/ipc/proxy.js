"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.IPCProxy = void 0;
const error_list_1 = __importDefault(require("../../../errors/error-list"));
const async_event_emitter_1 = __importDefault(require("../../../utils/async-event-emitter"));
const interfaces_1 = require("./interfaces");
const prerender_callsite_1 = __importDefault(require("../../../utils/prerender-callsite"));
class IPCProxy extends async_event_emitter_1.default {
    constructor(transport) {
        super();
        this._requestCounter = 0;
        this._transport = transport;
        this._handlers = {};
        this._transport.read();
        this._transport.on(interfaces_1.IPCTransportEvents.data, rawPacket => this._onRead(rawPacket));
        this.on('request', data => this._onRequest(data));
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    _saveError(error) {
        if (interfaces_1.isTestCafeErrorList(error)) {
            for (const item of error.items) {
                if (item.callsite)
                    item.callsite = prerender_callsite_1.default(item.callsite);
            }
            return error;
        }
        // NOTE: The properties of the 'Error' class lost during serialization using the 'JSON.stringify' way
        // because they are not enumerable.
        // We clone the object and copy these properties explicitly to mark these properties as enumerable.
        const errorData = Object.assign({}, error);
        errorData.name = errorData.name || error.name;
        errorData.message = errorData.message || error.message;
        errorData.stack = errorData.stack || error.stack;
        return errorData;
    }
    async _onRead(packet) {
        if (packet.type === interfaces_1.IPCPacketType.response)
            this.emit(`response-${packet.id}`, packet);
        else
            this.emit('request', packet);
    }
    async _onRequest(requestPacket) {
        let resultData = null;
        try {
            resultData = { result: await this._handlers[requestPacket.data.name](...requestPacket.data.args) };
        }
        catch (error) {
            resultData = { error: this._saveError(error) };
        }
        const responsePacket = {
            id: requestPacket.id,
            type: interfaces_1.IPCPacketType.response,
            sync: requestPacket.sync,
            data: resultData
        };
        await this._transport.write(responsePacket);
    }
    _createPacket(opts) {
        return {
            id: this._requestCounter++,
            type: interfaces_1.IPCPacketType.request,
            sync: opts.sync,
            data: opts.data
        };
    }
    _createPlainError(errorData) {
        const error = new Error(errorData.message);
        Object.assign(error, errorData);
        return error;
    }
    _createError(errorData) {
        if (interfaces_1.isTestCafeErrorList(errorData)) {
            const errorList = new error_list_1.default();
            errorList.items = errorData.items;
            return errorList;
        }
        return this._createPlainError(errorData);
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    register(func, context = null) {
        if (this._handlers[func.name])
            return;
        this._handlers[func.name] = func.bind(context);
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    async call(target, ...args) {
        const name = typeof target === 'string' ? target : target.name;
        const packet = this._createPacket({ data: { name, args }, sync: false });
        const responsePromise = this.once(`response-${packet.id}`);
        await this._transport.write(packet);
        const { data } = await responsePromise;
        if (interfaces_1.isIPCErrorResponse(data))
            throw this._createError(data.error);
        return data.result;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    callSync(target, ...args) {
        const name = typeof target === 'string' ? target : target.name;
        const requestPacket = this._createPacket({ data: { name, args }, sync: true });
        this._transport.writeSync(requestPacket);
        let responsePacket = this._transport.readSync();
        while (responsePacket.id !== requestPacket.id)
            responsePacket = this._transport.readSync();
        const response = responsePacket.data;
        if (interfaces_1.isIPCErrorResponse(response))
            throw this._createError(response.error);
        return response.result;
    }
}
exports.IPCProxy = IPCProxy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2VydmljZXMvdXRpbHMvaXBjL3Byb3h5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRFQUEyRDtBQUMzRCw2RkFBOEQ7QUFFOUQsNkNBYXNCO0FBRXRCLDJGQUFrRTtBQVFsRSxNQUFhLFFBQVMsU0FBUSw2QkFBWTtJQUt0QyxZQUFvQixTQUF1QjtRQUN2QyxLQUFLLEVBQUUsQ0FBQztRQUpKLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBTWhDLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBRTVCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBRXBCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsK0JBQWtCLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCw4REFBOEQ7SUFDdEQsVUFBVSxDQUFFLEtBQW9CO1FBQ3BDLElBQUksZ0NBQW1CLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDNUIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO2dCQUM1QixJQUFJLElBQUksQ0FBQyxRQUFRO29CQUNiLElBQUksQ0FBQyxRQUFRLEdBQUcsNEJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3hEO1lBRUQsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFFRCxxR0FBcUc7UUFDckcsbUNBQW1DO1FBQ25DLG1HQUFtRztRQUNuRyxN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QUM7UUFFekMsSUFBSSxjQUFjLEdBQXNCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFbkUsT0FBTyxjQUFjLENBQUMsRUFBRSxLQUFLLGFBQWEsQ0FBQyxFQUFFO1lBQ3pDLGNBQWMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRWhELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUM7UUFFckMsSUFBSSwrQkFBa0IsQ0FBQyxRQUFRLENBQUM7WUFDNUIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU1QyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDM0IsQ0FBQztDQUNKO0FBNUlELDRCQTRJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUZXN0Q2FmZUVycm9yTGlzdCBmcm9tICcuLi8uLi8uLi9lcnJvcnMvZXJyb3ItbGlzdCc7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJy4uLy4uLy4uL3V0aWxzL2FzeW5jLWV2ZW50LWVtaXR0ZXInO1xuXG5pbXBvcnQge1xuICAgIEV4dGVybmFsRXJyb3IsXG4gICAgaXNUZXN0Q2FmZUVycm9yTGlzdCxcblxuICAgIElQQ1BhY2tldCxcbiAgICBJUENQYWNrZXRUeXBlLFxuICAgIElQQ1JlcXVlc3RQYWNrZXQsXG4gICAgSVBDUmVzcG9uc2VQYWNrZXQsXG4gICAgSVBDUmVxdWVzdERhdGEsXG4gICAgaXNJUENFcnJvclJlc3BvbnNlLFxuXG4gICAgSVBDVHJhbnNwb3J0RXZlbnRzLFxuICAgIElQQ1RyYW5zcG9ydCxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHByZXJlbmRlckNhbGxzaXRlIGZyb20gJy4uLy4uLy4uL3V0aWxzL3ByZXJlbmRlci1jYWxsc2l0ZSc7XG5cblxuaW50ZXJmYWNlIFJlcXVlc3RPcHRpb25zIHtcbiAgICBkYXRhOiBJUENSZXF1ZXN0RGF0YTtcbiAgICBzeW5jOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgSVBDUHJveHkgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgX3RyYW5zcG9ydDogSVBDVHJhbnNwb3J0O1xuICAgIHByaXZhdGUgX3JlcXVlc3RDb3VudGVyOiBudW1iZXIgPSAwO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2hhbmRsZXJzOiB7IFtuYW1lOiBzdHJpbmddOiBGdW5jdGlvbiB9O1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yICh0cmFuc3BvcnQ6IElQQ1RyYW5zcG9ydCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydCA9IHRyYW5zcG9ydDtcblxuICAgICAgICB0aGlzLl9oYW5kbGVycyA9IHt9O1xuXG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydC5yZWFkKCk7XG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydC5vbihJUENUcmFuc3BvcnRFdmVudHMuZGF0YSwgcmF3UGFja2V0ID0+IHRoaXMuX29uUmVhZChyYXdQYWNrZXQpKTtcbiAgICAgICAgdGhpcy5vbigncmVxdWVzdCcsIGRhdGEgPT4gdGhpcy5fb25SZXF1ZXN0KGRhdGEpKTtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHByaXZhdGUgX3NhdmVFcnJvciAoZXJyb3I6IEV4dGVybmFsRXJyb3IpOiBhbnkge1xuICAgICAgICBpZiAoaXNUZXN0Q2FmZUVycm9yTGlzdChlcnJvcikpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBlcnJvci5pdGVtcykge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtLmNhbGxzaXRlKVxuICAgICAgICAgICAgICAgICAgICBpdGVtLmNhbGxzaXRlID0gcHJlcmVuZGVyQ2FsbHNpdGUoaXRlbS5jYWxsc2l0ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5PVEU6IFRoZSBwcm9wZXJ0aWVzIG9mIHRoZSAnRXJyb3InIGNsYXNzIGxvc3QgZHVyaW5nIHNlcmlhbGl6YXRpb24gdXNpbmcgdGhlICdKU09OLnN0cmluZ2lmeScgd2F5XG4gICAgICAgIC8vIGJlY2F1c2UgdGhleSBhcmUgbm90IGVudW1lcmFibGUuXG4gICAgICAgIC8vIFdlIGNsb25lIHRoZSBvYmplY3QgYW5kIGNvcHkgdGhlc2UgcHJvcGVydGllcyBleHBsaWNpdGx5IHRvIG1hcmsgdGhlc2UgcHJvcGVydGllcyBhcyBlbnVtZXJhYmxlLlxuICAgICAgICBjb25zdCBlcnJvckRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBlcnJvcik7XG5cbiAgICAgICAgZXJyb3JEYXRhLm5hbWUgICAgPSBlcnJvckRhdGEubmFtZSB8fCBlcnJvci5uYW1lO1xuICAgICAgICBlcnJvckRhdGEubWVzc2FnZSA9IGVycm9yRGF0YS5tZXNzYWdlIHx8IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgIGVycm9yRGF0YS5zdGFjayAgID0gZXJyb3JEYXRhLnN0YWNrIHx8IGVycm9yLnN0YWNrO1xuXG4gICAgICAgIHJldHVybiBlcnJvckRhdGE7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfb25SZWFkIChwYWNrZXQ6IElQQ1BhY2tldCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAocGFja2V0LnR5cGUgPT09IElQQ1BhY2tldFR5cGUucmVzcG9uc2UpXG4gICAgICAgICAgICB0aGlzLmVtaXQoYHJlc3BvbnNlLSR7cGFja2V0LmlkfWAsIHBhY2tldCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncmVxdWVzdCcsIHBhY2tldCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfb25SZXF1ZXN0IChyZXF1ZXN0UGFja2V0OiBJUENSZXF1ZXN0UGFja2V0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCByZXN1bHREYXRhID0gbnVsbDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzdWx0RGF0YSA9IHsgcmVzdWx0OiBhd2FpdCB0aGlzLl9oYW5kbGVyc1tyZXF1ZXN0UGFja2V0LmRhdGEubmFtZV0oLi4ucmVxdWVzdFBhY2tldC5kYXRhLmFyZ3MpIH07XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXN1bHREYXRhID0geyBlcnJvcjogdGhpcy5fc2F2ZUVycm9yKGVycm9yKSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VQYWNrZXQ6IElQQ1Jlc3BvbnNlUGFja2V0ID0ge1xuICAgICAgICAgICAgaWQ6ICAgcmVxdWVzdFBhY2tldC5pZCxcbiAgICAgICAgICAgIHR5cGU6IElQQ1BhY2tldFR5cGUucmVzcG9uc2UsXG4gICAgICAgICAgICBzeW5jOiByZXF1ZXN0UGFja2V0LnN5bmMsXG5cbiAgICAgICAgICAgIGRhdGE6IHJlc3VsdERhdGFcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCB0aGlzLl90cmFuc3BvcnQud3JpdGUocmVzcG9uc2VQYWNrZXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZVBhY2tldCAob3B0czogUmVxdWVzdE9wdGlvbnMpOiBJUENSZXF1ZXN0UGFja2V0IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiAgIHRoaXMuX3JlcXVlc3RDb3VudGVyKyssXG4gICAgICAgICAgICB0eXBlOiBJUENQYWNrZXRUeXBlLnJlcXVlc3QsXG4gICAgICAgICAgICBzeW5jOiBvcHRzLnN5bmMsXG4gICAgICAgICAgICBkYXRhOiBvcHRzLmRhdGFcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jcmVhdGVQbGFpbkVycm9yIChlcnJvckRhdGE6IEVycm9yKTogRXJyb3Ige1xuICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihlcnJvckRhdGEubWVzc2FnZSk7XG5cbiAgICAgICAgT2JqZWN0LmFzc2lnbihlcnJvciwgZXJyb3JEYXRhKTtcblxuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlRXJyb3IgKGVycm9yRGF0YTogRXh0ZXJuYWxFcnJvcik6IEV4dGVybmFsRXJyb3Ige1xuICAgICAgICBpZiAoaXNUZXN0Q2FmZUVycm9yTGlzdChlcnJvckRhdGEpKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvckxpc3QgPSBuZXcgVGVzdENhZmVFcnJvckxpc3QoKTtcblxuICAgICAgICAgICAgZXJyb3JMaXN0Lml0ZW1zID0gZXJyb3JEYXRhLml0ZW1zO1xuXG4gICAgICAgICAgICByZXR1cm4gZXJyb3JMaXN0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZVBsYWluRXJyb3IoZXJyb3JEYXRhKTtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHB1YmxpYyByZWdpc3RlciAoZnVuYzogRnVuY3Rpb24sIGNvbnRleHQ6IGFueSA9IG51bGwpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX2hhbmRsZXJzW2Z1bmMubmFtZV0pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5faGFuZGxlcnNbZnVuYy5uYW1lXSA9IGZ1bmMuYmluZChjb250ZXh0KTtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHB1YmxpYyBhc3luYyBjYWxsICh0YXJnZXQ6IHN0cmluZ3xGdW5jdGlvbiwgLi4uYXJnczogYW55W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBuYW1lICAgICAgICAgICAgPSB0eXBlb2YgdGFyZ2V0ID09PSAnc3RyaW5nJyA/IHRhcmdldCA6IHRhcmdldC5uYW1lO1xuICAgICAgICBjb25zdCBwYWNrZXQgICAgICAgICAgPSB0aGlzLl9jcmVhdGVQYWNrZXQoeyBkYXRhOiB7IG5hbWUsIGFyZ3MgfSwgc3luYzogZmFsc2UgfSk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlUHJvbWlzZSA9IHRoaXMub25jZShgcmVzcG9uc2UtJHtwYWNrZXQuaWR9YCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fdHJhbnNwb3J0LndyaXRlKHBhY2tldCk7XG5cbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCByZXNwb25zZVByb21pc2U7XG5cbiAgICAgICAgaWYgKGlzSVBDRXJyb3JSZXNwb25zZShkYXRhKSlcbiAgICAgICAgICAgIHRocm93IHRoaXMuX2NyZWF0ZUVycm9yKGRhdGEuZXJyb3IpO1xuXG4gICAgICAgIHJldHVybiBkYXRhLnJlc3VsdDtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHB1YmxpYyBjYWxsU3luYyAodGFyZ2V0OiBzdHJpbmd8RnVuY3Rpb24sIC4uLmFyZ3M6IGFueVtdKTogYW55IHtcbiAgICAgICAgY29uc3QgbmFtZSAgICAgICAgICA9IHR5cGVvZiB0YXJnZXQgPT09ICdzdHJpbmcnID8gdGFyZ2V0IDogdGFyZ2V0Lm5hbWU7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RQYWNrZXQgPSB0aGlzLl9jcmVhdGVQYWNrZXQoeyBkYXRhOiB7IG5hbWUsIGFyZ3MgfSwgc3luYzogdHJ1ZSB9KTtcblxuICAgICAgICB0aGlzLl90cmFuc3BvcnQud3JpdGVTeW5jKHJlcXVlc3RQYWNrZXQpO1xuXG4gICAgICAgIGxldCByZXNwb25zZVBhY2tldDogSVBDUmVzcG9uc2VQYWNrZXQgPSB0aGlzLl90cmFuc3BvcnQucmVhZFN5bmMoKTtcblxuICAgICAgICB3aGlsZSAocmVzcG9uc2VQYWNrZXQuaWQgIT09IHJlcXVlc3RQYWNrZXQuaWQpXG4gICAgICAgICAgICByZXNwb25zZVBhY2tldCA9IHRoaXMuX3RyYW5zcG9ydC5yZWFkU3luYygpO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gcmVzcG9uc2VQYWNrZXQuZGF0YTtcblxuICAgICAgICBpZiAoaXNJUENFcnJvclJlc3BvbnNlKHJlc3BvbnNlKSlcbiAgICAgICAgICAgIHRocm93IHRoaXMuX2NyZWF0ZUVycm9yKHJlc3BvbnNlLmVycm9yKTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0O1xuICAgIH1cbn1cbiJdfQ==