"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.restore = exports.serialize = exports.flatten = exports.isFixture = exports.isTest = void 0;
const lodash_1 = require("lodash");
const protocol_1 = require("./protocol");
const unitTypes = __importStar(require("../../api/structure/unit-types"));
const RECURSIVE_PROPERTIES = ['testFile', 'fixture', 'currentFixture', 'collectedTests'];
function isProperty(object, property) {
    return object.hasOwnProperty(property);
}
function isTest(value) {
    return value.unitTypeName === unitTypes.TEST;
}
exports.isTest = isTest;
function isFixture(value) {
    return value.unitTypeName === unitTypes.FIXTURE;
}
exports.isFixture = isFixture;
function mapProperties(object, properties, mapper) {
    for (const property of properties) {
        if (!isProperty(object, property))
            continue;
        const value = object[property];
        if (Array.isArray(value))
            object[property] = value.map(item => mapper({ item, property, object }));
        else
            object[property] = mapper({ item: object[property], property, object });
    }
}
function replaceTestFunctions(unit) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item }) => !!item);
}
function restoreTestFunctions(unit, mapper) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item, object, property }) => item ? mapper(object.id, property) : item);
}
function flattenRecursiveProperties(unit) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => item.id);
}
function restoreRecursiveProperties(unit, units) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => units[item]);
}
function flatten(tests) {
    const testFiles = lodash_1.uniq(tests.map(test => test.testFile));
    const fixtures = lodash_1.uniq(tests.map(test => test.fixture));
    return lodash_1.keyBy([...tests, ...fixtures, ...testFiles], unit => unit.id);
}
exports.flatten = flatten;
function serialize(units) {
    const result = {};
    for (const unit of Object.values(units)) {
        const copy = Object.assign({}, unit);
        replaceTestFunctions(copy);
        flattenRecursiveProperties(copy);
        result[copy.id] = copy;
    }
    return result;
}
exports.serialize = serialize;
function restore(units, mapper) {
    const list = Object.values(units);
    const result = [];
    for (const unit of list) {
        restoreRecursiveProperties(unit, units);
        restoreTestFunctions(unit, mapper);
    }
    for (const unit of list) {
        if (isTest(unit))
            result.push(unit);
    }
    return result;
}
exports.restore = restore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zdHJ1Y3R1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1zdHJ1Y3R1cmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1DQUFxQztBQUNyQyx5Q0FBc0Q7QUFHdEQsMEVBQTREO0FBRzVELE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxVQUFVLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixDQUFVLENBQUM7QUFzQmxHLFNBQVMsVUFBVSxDQUFvQixNQUFTLEVBQUUsUUFBZ0I7SUFDOUQsT0FBTyxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFFRCxTQUFnQixNQUFNLENBQUUsS0FBVztJQUMvQixPQUFPLEtBQUssQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDLElBQUksQ0FBQztBQUNqRCxDQUFDO0FBRkQsd0JBRUM7QUFFRCxTQUFnQixTQUFTLENBQUUsS0FBVztJQUNsQyxPQUFPLEtBQUssQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDLE9BQU8sQ0FBQztBQUNwRCxDQUFDO0FBRkQsOEJBRUM7QUFFRCxTQUFTLGFBQWEsQ0FBNEQsTUFBUyxFQUFFLFVBQWEsRUFBRSxNQUE0QjtJQUNwSSxLQUFLLE1BQU0sUUFBUSxJQUFJLFVBQVUsRUFBRTtRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUM7WUFDN0IsU0FBUztRQUViLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUvQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEs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SSxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ1osTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN6QjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFoQkQsMEJBZ0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdW5pcSwga2V5QnkgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgVEVTVF9GVU5DVElPTl9QUk9QRVJUSUVTIH0gZnJvbSAnLi9wcm90b2NvbCc7XG5cbmltcG9ydCB7IEZpeHR1cmUsIFRlc3QsIFRlc3RGaWxlIH0gZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIHVuaXRUeXBlcyBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL3VuaXQtdHlwZXMnO1xuXG5cbmNvbnN0IFJFQ1VSU0lWRV9QUk9QRVJUSUVTID0gWyd0ZXN0RmlsZScsICdmaXh0dXJlJywgJ2N1cnJlbnRGaXh0dXJlJywgJ2NvbGxlY3RlZFRlc3RzJ10gYXMgY29uc3Q7XG5cbmludGVyZmFjZSBGdW5jdGlvbk1hcHBlciB7XG4gICAgKGlkOiBzdHJpbmcsIGZ1bmN0aW9uTmFtZTogdHlwZW9mIFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFU1tudW1iZXJdKTogRnVuY3Rpb247XG59XG5cbmludGVyZmFjZSBNYXBwZXJBcmd1bWVudHM8VCwgUD4ge1xuICAgIG9iamVjdDogVDtcbiAgICBwcm9wZXJ0eTogUDtcbiAgICBpdGVtOiBhbnk7XG59XG5cbmludGVyZmFjZSBNYXBwZXI8VCwgUD4ge1xuICAgICh7IGl0ZW0sIHByb3BlcnR5LCBvYmplY3QgfTogTWFwcGVyQXJndW1lbnRzPFQsIFA+KTogYW55O1xufVxuXG5leHBvcnQgdHlwZSBVbml0ID0gVGVzdCB8IEZpeHR1cmUgfCBUZXN0RmlsZTtcblxuZXhwb3J0IGludGVyZmFjZSBVbml0cyB7XG4gICAgW2lkOiBzdHJpbmddOiBVbml0O1xufVxuXG5mdW5jdGlvbiBpc1Byb3BlcnR5PFQgZXh0ZW5kcyBvYmplY3Q+IChvYmplY3Q6IFQsIHByb3BlcnR5OiBzdHJpbmcpOiBwcm9wZXJ0eSBpcyBFeHRyYWN0PGtleW9mIFQsIHN0cmluZz4ge1xuICAgIHJldHVybiBvYmplY3QuaGFzT3duUHJvcGVydHkocHJvcGVydHkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNUZXN0ICh2YWx1ZTogVW5pdCk6IHZhbHVlIGlzIFRlc3Qge1xuICAgIHJldHVybiB2YWx1ZS51bml0VHlwZU5hbWUgPT09IHVuaXRUeXBlcy5URVNUO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaXh0dXJlICh2YWx1ZTogVW5pdCk6IHZhbHVlIGlzIEZpeHR1cmUge1xuICAgIHJldHVybiB2YWx1ZS51bml0VHlwZU5hbWUgPT09IHVuaXRUeXBlcy5GSVhUVVJFO1xufVxuXG5mdW5jdGlvbiBtYXBQcm9wZXJ0aWVzPFQgZXh0ZW5kcyBSZWFkb25seTxvYmplY3Q+LCBQIGV4dGVuZHMgUmVhZG9ubHk8c3RyaW5nW10+PiAob2JqZWN0OiBULCBwcm9wZXJ0aWVzOiBQLCBtYXBwZXI6IE1hcHBlcjxULCBQW251bWJlcl0+KTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmICghaXNQcm9wZXJ0eShvYmplY3QsIHByb3BlcnR5KSlcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTtcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gdmFsdWUubWFwKGl0ZW0gPT4gbWFwcGVyKHsgaXRlbSwgcHJvcGVydHksIG9iamVjdCB9KSkgYXMgYW55O1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gbWFwcGVyKHsgaXRlbTogb2JqZWN0W3Byb3BlcnR5XSwgcHJvcGVydHksIG9iamVjdCB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VUZXN0RnVuY3Rpb25zICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gISFpdGVtKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVRlc3RGdW5jdGlvbnMgKHVuaXQ6IFVuaXQsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFUywgKHsgaXRlbSwgb2JqZWN0LCBwcm9wZXJ0eSB9KSA9PiBpdGVtID8gbWFwcGVyKG9iamVjdC5pZCwgcHJvcGVydHkpIDogaXRlbSk7XG59XG5cbmZ1bmN0aW9uIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBSRUNVUlNJVkVfUFJPUEVSVElFUywgKHsgaXRlbSB9KSA9PiBpdGVtLmlkKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVJlY3Vyc2l2ZVByb3BlcnRpZXMgKHVuaXQ6IFVuaXQsIHVuaXRzOiBVbml0cyk6IHZvaWQge1xuICAgIG1hcFByb3BlcnRpZXModW5pdCwgUkVDVVJTSVZFX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gdW5pdHNbaXRlbV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbiAodGVzdHM6IFRlc3RbXSk6IFVuaXRzIHtcbiAgICBjb25zdCB0ZXN0RmlsZXMgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QudGVzdEZpbGUpKTtcbiAgICBjb25zdCBmaXh0dXJlcyAgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QuZml4dHVyZSkpO1xuXG4gICAgcmV0dXJuIGtleUJ5KFsuLi50ZXN0cywgLi4uZml4dHVyZXMsIC4uLnRlc3RGaWxlc10sIHVuaXQgPT4gdW5pdC5pZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUgKHVuaXRzOiBVbml0cyk6IFVuaXRzIHtcbiAgICBjb25zdCByZXN1bHQ6IFVuaXRzID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgT2JqZWN0LnZhbHVlcyh1bml0cykpIHtcbiAgICAgICAgY29uc3QgY29weTogVW5pdCA9IHsgLi4udW5pdCB9O1xuXG4gICAgICAgIHJlcGxhY2VUZXN0RnVuY3Rpb25zKGNvcHkpO1xuICAgICAgICBmbGF0dGVuUmVjdXJzaXZlUHJvcGVydGllcyhjb3B5KTtcblxuICAgICAgICByZXN1bHRbY29weS5pZF0gPSBjb3B5O1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXN0b3JlICh1bml0czogVW5pdHMsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiBUZXN0W10ge1xuICAgIGNvbnN0IGxpc3QgPSBPYmplY3QudmFsdWVzKHVuaXRzKTtcblxuICAgIGNvbnN0IHJlc3VsdDogVGVzdFtdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgbGlzdCkge1xuICAgICAgICByZXN0b3JlUmVjdXJzaXZlUHJvcGVydGllcyh1bml0LCB1bml0cyk7XG4gICAgICAgIHJlc3RvcmVUZXN0RnVuY3Rpb25zKHVuaXQsIG1hcHBlcik7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCB1bml0IG9mIGxpc3QpIHtcbiAgICAgICAgaWYgKGlzVGVzdCh1bml0KSlcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHVuaXQpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG4iXX0=