"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.restore = exports.serialize = exports.flatten = exports.isFixture = exports.isTest = void 0;
const lodash_1 = require("lodash");
const protocol_1 = require("./protocol");
const unit_type_1 = __importDefault(require("../../api/structure/unit-type"));
const RECURSIVE_PROPERTIES = ['testFile', 'fixture', 'currentFixture', 'collectedTests'];
function isProperty(object, property) {
    return object.hasOwnProperty(property);
}
function isTest(value) {
    return value.unitType === unit_type_1.default.test;
}
exports.isTest = isTest;
function isFixture(value) {
    return value.unitType === unit_type_1.default.fixture;
}
exports.isFixture = isFixture;
function mapProperties(object, properties, mapper) {
    for (const property of properties) {
        if (!isProperty(object, property))
            continue;
        const value = object[property];
        if (Array.isArray(value))
            object[property] = value.map(item => mapper({ item, property, object }));
        else
            object[property] = mapper({ item: object[property], property, object });
    }
}
function replaceTestFunctions(unit) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item }) => !!item);
}
function restoreTestFunctions(unit, mapper) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item, object, property }) => item ? mapper(object.id, property) : item);
}
function flattenRecursiveProperties(unit) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => item.id);
}
function restoreRecursiveProperties(unit, units) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => units[item]);
}
function flatten(tests) {
    const testFiles = lodash_1.uniq(tests.map(test => test.testFile));
    const fixtures = lodash_1.uniq(tests.map(test => test.fixture));
    return lodash_1.keyBy([...tests, ...fixtures, ...testFiles], unit => unit.id);
}
exports.flatten = flatten;
function serialize(units) {
    const result = {};
    for (const unit of Object.values(units)) {
        // @ts-ignore
        const copy = Object.assign({}, unit);
        replaceTestFunctions(copy);
        flattenRecursiveProperties(copy);
        result[copy.id] = copy;
    }
    return result;
}
exports.serialize = serialize;
function restore(units, mapper) {
    const list = Object.values(units);
    const result = [];
    for (const unit of list) {
        restoreRecursiveProperties(unit, units);
        restoreTestFunctions(unit, mapper);
    }
    for (const unit of list) {
        if (isTest(unit))
            result.push(unit);
    }
    return result;
}
exports.restore = restore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zdHJ1Y3R1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1zdHJ1Y3R1cmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsbUNBQXFDO0FBQ3JDLHlDQUFzRDtBQUt0RCw4RUFBcUQ7QUFHckQsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQVUsQ0FBQztBQXNCbEcsU0FBUyxVQUFVLENBQW9CLE1BQVMsRUFBRSxRQUFnQjtJQUM5RCxPQUFPLE1BQU0sQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUVELFNBQWdCLE1BQU0sQ0FBRSxLQUFXO0lBQy9CLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxtQkFBUSxDQUFDLElBQUksQ0FBQztBQUM1QyxDQUFDO0FBRkQsd0JBRUM7QUFFRCxTQUFnQixTQUFTLENBQUUsS0FBVztJQUNsQyxPQUFPLEtBQUssQ0FBQyxRQUFRLEtBQUssbUJBQVEsQ0FBQyxPQUFPLENBQUM7QUFDL0MsQ0FBQztBQUZELDhCQUVDO0FBRUQsU0FBUyxhQUFhLENBQTRELE1BQVMsRUFBRSxVQUFhLEVBQUUsTUFBNEI7SUFDcEksS0FBSyxNQUFNLFFBQVEsSUFBSSxVQUFVLEVBQUU7UUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDO1lBQzdCLFNBQVM7UUFFYixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFL0IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFF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QU0sQ0FBQyxJQUFJLENBQUM7WUFDWixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQWhCRCwwQkFnQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1bmlxLCBrZXlCeSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVMgfSBmcm9tICcuL3Byb3RvY29sJztcblxuaW1wb3J0IFRlc3QgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0JztcbmltcG9ydCBGaXh0dXJlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvZml4dHVyZSc7XG5pbXBvcnQgVGVzdEZpbGUgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0LWZpbGUnO1xuaW1wb3J0IFVuaXRUeXBlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdW5pdC10eXBlJztcblxuXG5jb25zdCBSRUNVUlNJVkVfUFJPUEVSVElFUyA9IFsndGVzdEZpbGUnLCAnZml4dHVyZScsICdjdXJyZW50Rml4dHVyZScsICdjb2xsZWN0ZWRUZXN0cyddIGFzIGNvbnN0O1xuXG5pbnRlcmZhY2UgRnVuY3Rpb25NYXBwZXIge1xuICAgIChpZDogc3RyaW5nLCBmdW5jdGlvbk5hbWU6IHR5cGVvZiBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVNbbnVtYmVyXSk6IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyQXJndW1lbnRzPFQsIFA+IHtcbiAgICBvYmplY3Q6IFQ7XG4gICAgcHJvcGVydHk6IFA7XG4gICAgaXRlbTogYW55O1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyPFQsIFA+IHtcbiAgICAoeyBpdGVtLCBwcm9wZXJ0eSwgb2JqZWN0IH06IE1hcHBlckFyZ3VtZW50czxULCBQPik6IGFueTtcbn1cblxuZXhwb3J0IHR5cGUgVW5pdCA9IFRlc3QgfCBGaXh0dXJlIHwgVGVzdEZpbGU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5pdHMge1xuICAgIFtpZDogc3RyaW5nXTogVW5pdDtcbn1cblxuZnVuY3Rpb24gaXNQcm9wZXJ0eTxUIGV4dGVuZHMgb2JqZWN0PiAob2JqZWN0OiBULCBwcm9wZXJ0eTogc3RyaW5nKTogcHJvcGVydHkgaXMgRXh0cmFjdDxrZXlvZiBULCBzdHJpbmc+IHtcbiAgICByZXR1cm4gb2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVGVzdCAodmFsdWU6IFVuaXQpOiB2YWx1ZSBpcyBUZXN0IHtcbiAgICByZXR1cm4gdmFsdWUudW5pdFR5cGUgPT09IFVuaXRUeXBlLnRlc3Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpeHR1cmUgKHZhbHVlOiBVbml0KTogdmFsdWUgaXMgRml4dHVyZSB7XG4gICAgcmV0dXJuIHZhbHVlLnVuaXRUeXBlID09PSBVbml0VHlwZS5maXh0dXJlO1xufVxuXG5mdW5jdGlvbiBtYXBQcm9wZXJ0aWVzPFQgZXh0ZW5kcyBSZWFkb25seTxvYmplY3Q+LCBQIGV4dGVuZHMgUmVhZG9ubHk8c3RyaW5nW10+PiAob2JqZWN0OiBULCBwcm9wZXJ0aWVzOiBQLCBtYXBwZXI6IE1hcHBlcjxULCBQW251bWJlcl0+KTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmICghaXNQcm9wZXJ0eShvYmplY3QsIHByb3BlcnR5KSlcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTtcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gdmFsdWUubWFwKGl0ZW0gPT4gbWFwcGVyKHsgaXRlbSwgcHJvcGVydHksIG9iamVjdCB9KSkgYXMgYW55O1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gbWFwcGVyKHsgaXRlbTogb2JqZWN0W3Byb3BlcnR5XSwgcHJvcGVydHksIG9iamVjdCB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VUZXN0RnVuY3Rpb25zICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gISFpdGVtKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVRlc3RGdW5jdGlvbnMgKHVuaXQ6IFVuaXQsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFUywgKHsgaXRlbSwgb2JqZWN0LCBwcm9wZXJ0eSB9KSA9PiBpdGVtID8gbWFwcGVyKG9iamVjdC5pZCwgcHJvcGVydHkpIDogaXRlbSk7XG59XG5cbmZ1bmN0aW9uIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBSRUNVUlNJVkVfUFJPUEVSVElFUywgKHsgaXRlbSB9KSA9PiBpdGVtLmlkKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVJlY3Vyc2l2ZVByb3BlcnRpZXMgKHVuaXQ6IFVuaXQsIHVuaXRzOiBVbml0cyk6IHZvaWQge1xuICAgIG1hcFByb3BlcnRpZXModW5pdCwgUkVDVVJTSVZFX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gdW5pdHNbaXRlbV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbiAodGVzdHM6IFRlc3RbXSk6IFVuaXRzIHtcbiAgICBjb25zdCB0ZXN0RmlsZXMgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QudGVzdEZpbGUpKTtcbiAgICBjb25zdCBmaXh0dXJlcyAgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QuZml4dHVyZSkpO1xuXG4gICAgcmV0dXJuIGtleUJ5KFsuLi50ZXN0cywgLi4uZml4dHVyZXMsIC4uLnRlc3RGaWxlc10sIHVuaXQgPT4gdW5pdC5pZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUgKHVuaXRzOiBVbml0cyk6IFVuaXRzIHtcbiAgICBjb25zdCByZXN1bHQ6IFVuaXRzID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgT2JqZWN0LnZhbHVlcyh1bml0cykpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCBjb3B5OiBVbml0ID0geyAuLi51bml0IH07XG5cbiAgICAgICAgcmVwbGFjZVRlc3RGdW5jdGlvbnMoY29weSk7XG4gICAgICAgIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzKGNvcHkpO1xuXG4gICAgICAgIHJlc3VsdFtjb3B5LmlkXSA9IGNvcHk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc3RvcmUgKHVuaXRzOiBVbml0cywgbWFwcGVyOiBGdW5jdGlvbk1hcHBlcik6IFRlc3RbXSB7XG4gICAgY29uc3QgbGlzdCA9IE9iamVjdC52YWx1ZXModW5pdHMpO1xuXG4gICAgY29uc3QgcmVzdWx0OiBUZXN0W10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgdW5pdCBvZiBsaXN0KSB7XG4gICAgICAgIHJlc3RvcmVSZWN1cnNpdmVQcm9wZXJ0aWVzKHVuaXQsIHVuaXRzKTtcbiAgICAgICAgcmVzdG9yZVRlc3RGdW5jdGlvbnModW5pdCwgbWFwcGVyKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgbGlzdCkge1xuICAgICAgICBpZiAoaXNUZXN0KHVuaXQpKVxuICAgICAgICAgICAgcmVzdWx0LnB1c2godW5pdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==